/*
 * Click nbfs://nbhost/SystemFileSystem/Templates/Licenses/license-default.txt to change this license
 * Click nbfs://nbhost/SystemFileSystem/Templates/GUIForms/JFrame.java to edit this template
 */
package view;

import dao.ProduitDAO;
import dao.CategorieDAO;
import model.Produit;
import model.Categorie;
import javax.swing.*;
import javax.swing.table.DefaultTableModel;
import javax.swing.table.TableRowSorter;
import javax.swing.RowFilter;
import java.awt.*;
import java.awt.event.KeyAdapter;
import java.awt.event.KeyEvent;
import java.util.List;
import javax.swing.event.DocumentEvent;
import javax.swing.event.DocumentListener;

/**
 *
 * @author logos
 */
public class GestionProduitsForm extends javax.swing.JFrame {
    
    private static final java.util.logging.Logger logger = java.util.logging.Logger.getLogger(GestionProduitsForm.class.getName());
    // DAOs
    private ProduitDAO produitDAO;
    private CategorieDAO categorieDAO;
    
    // Mod√®le de tableau
    private DefaultTableModel tableModel;
    private TableRowSorter<DefaultTableModel> sorter;
    
    // √âtat courant
    private boolean modeAjout = true;
    private int produitSelectionneId = -1;
    
    /**
     * Creates new form GestionProduitsForm
     */
    public GestionProduitsForm() {
        initComponents();
        setupInterface();
        initialiserDonnees();
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jPanel1 = new javax.swing.JPanel();
        jbajouter = new javax.swing.JButton();
        jbmodifier = new javax.swing.JButton();
        jbsupprimer = new javax.swing.JButton();
        jbactualiser = new javax.swing.JButton();
        jlrechercher = new javax.swing.JLabel();
        jtrechercher = new javax.swing.JTextField();
        jbrechercher = new javax.swing.JButton();
        jscrollPane = new javax.swing.JScrollPane();
        jttableproduits = new javax.swing.JTable();
        jpformulaire = new javax.swing.JPanel();
        jlnom = new javax.swing.JLabel();
        txtNom = new javax.swing.JTextField();
        jlcat√©gorie = new javax.swing.JLabel();
        jccategorie = new javax.swing.JComboBox<>();
        jlprix = new javax.swing.JLabel();
        txtPrix = new javax.swing.JTextField();
        jlstock = new javax.swing.JLabel();
        jlFCFA = new javax.swing.JLabel();
        txtStock = new javax.swing.JTextField();
        jlUnit√©s = new javax.swing.JLabel();
        jlSeuilalerte = new javax.swing.JLabel();
        txtSeuilAlerte = new javax.swing.JTextField();
        jLabel1 = new javax.swing.JLabel();
        jPanel2 = new javax.swing.JPanel();
        jbenregistrer = new javax.swing.JButton();
        jbannuler = new javax.swing.JButton();
        jbreinitialiser = new javax.swing.JButton();

        setDefaultCloseOperation(javax.swing.WindowConstants.DISPOSE_ON_CLOSE);
        setTitle("Gestion des Produits - Restaurant Management");
        setSize(new java.awt.Dimension(800, 600));

        jbajouter.setBackground(new java.awt.Color(46, 204, 113));
        jbajouter.setText("Ajouter");
        jbajouter.setFocusPainted(false);
        jbajouter.addActionListener(this::jbajouterActionPerformed);

        jbmodifier.setBackground(new java.awt.Color(52, 152, 219));
        jbmodifier.setText("Modifier");
        jbmodifier.setFocusPainted(false);
        jbmodifier.addActionListener(this::jbmodifierActionPerformed);

        jbsupprimer.setBackground(new java.awt.Color(231, 76, 60));
        jbsupprimer.setText("Supprimer");
        jbsupprimer.setFocusPainted(false);
        jbsupprimer.addActionListener(this::jbsupprimerActionPerformed);

        jbactualiser.setBackground(new java.awt.Color(241, 196, 15));
        jbactualiser.setText("Actualiser");
        jbactualiser.setFocusPainted(false);
        jbactualiser.addActionListener(this::jbactualiserActionPerformed);

        jlrechercher.setText("Rechercher :");
        jlrechercher.setToolTipText("");

        jbrechercher.setBackground(new java.awt.Color(149, 165, 166));
        jbrechercher.setText("üîç");
        jbrechercher.setFocusPainted(false);
        jbrechercher.addActionListener(this::jbrechercherActionPerformed);

        javax.swing.GroupLayout jPanel1Layout = new javax.swing.GroupLayout(jPanel1);
        jPanel1.setLayout(jPanel1Layout);
        jPanel1Layout.setHorizontalGroup(
            jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel1Layout.createSequentialGroup()
                .addContainerGap()
                .addComponent(jbajouter, javax.swing.GroupLayout.PREFERRED_SIZE, 72, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(18, 18, 18)
                .addComponent(jbmodifier, javax.swing.GroupLayout.PREFERRED_SIZE, 75, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(18, 18, 18)
                .addComponent(jbsupprimer)
                .addGap(18, 18, 18)
                .addComponent(jbactualiser)
                .addGap(18, 18, 18)
                .addComponent(jlrechercher)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(jtrechercher, javax.swing.GroupLayout.PREFERRED_SIZE, 200, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(jbrechercher)
                .addContainerGap(86, Short.MAX_VALUE))
        );
        jPanel1Layout.setVerticalGroup(
            jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, jPanel1Layout.createSequentialGroup()
                .addContainerGap(7, Short.MAX_VALUE)
                .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(jbajouter)
                    .addComponent(jbmodifier)
                    .addComponent(jbsupprimer)
                    .addComponent(jbactualiser)
                    .addComponent(jlrechercher)
                    .addComponent(jtrechercher, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(jbrechercher))
                .addContainerGap())
        );

        jscrollPane.setBackground(new java.awt.Color(0, 204, 204));

        jttableproduits.setAutoCreateRowSorter(true);
        jttableproduits.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {
                {null, null, null, null, null, null, null},
                {null, null, null, null, null, null, null},
                {null, null, null, null, null, null, null},
                {null, null, null, null, null, null, null}
            },
            new String [] {
                "ID", "Nom", "Categorie", "Prix(FCFA)", "Stock", "Seuil alerte", "Statut"
            }
        ) {
            Class[] types = new Class [] {
                java.lang.Integer.class, java.lang.String.class, java.lang.String.class, java.lang.Double.class, java.lang.Integer.class, java.lang.Integer.class, java.lang.String.class
            };
            boolean[] canEdit = new boolean [] {
                false, true, true, true, true, true, false
            };

            public Class getColumnClass(int columnIndex) {
                return types [columnIndex];
            }

            public boolean isCellEditable(int rowIndex, int columnIndex) {
                return canEdit [columnIndex];
            }
        });
        jttableproduits.setAutoResizeMode(javax.swing.JTable.AUTO_RESIZE_ALL_COLUMNS);
        jttableproduits.setGridColor(new java.awt.Color(211, 211, 211));
        jttableproduits.setRowHeight(25);
        jttableproduits.setSelectionBackground(new java.awt.Color(173, 216, 230));
        jttableproduits.setShowHorizontalLines(true);
        jttableproduits.setShowVerticalLines(true);
        jttableproduits.addMouseListener(new java.awt.event.MouseAdapter() {
            public void mouseClicked(java.awt.event.MouseEvent evt) {
                jttableproduitsMouseClicked(evt);
            }
        });
        jscrollPane.setViewportView(jttableproduits);
        if (jttableproduits.getColumnModel().getColumnCount() > 0) {
            jttableproduits.getColumnModel().getColumn(0).setPreferredWidth(50);
            jttableproduits.getColumnModel().getColumn(1).setResizable(false);
            jttableproduits.getColumnModel().getColumn(1).setPreferredWidth(150);
            jttableproduits.getColumnModel().getColumn(2).setPreferredWidth(100);
            jttableproduits.getColumnModel().getColumn(3).setPreferredWidth(80);
            jttableproduits.getColumnModel().getColumn(4).setPreferredWidth(60);
            jttableproduits.getColumnModel().getColumn(5).setPreferredWidth(80);
            jttableproduits.getColumnModel().getColumn(6).setPreferredWidth(80);
        }

        jpformulaire.setBorder(javax.swing.BorderFactory.createTitledBorder(""));
        jpformulaire.setToolTipText("Formulaire Produit");
        jpformulaire.setAutoscrolls(true);

        jlnom.setText("<html>Nom: <font color='red'>*</font></html>");

        txtNom.addActionListener(this::txtNomActionPerformed);

        jlcat√©gorie.setText("<html>Cat√©gorie: <font color='red'>*</font></html>");

        jccategorie.setModel(new javax.swing.DefaultComboBoxModel<>(new String[] { "Item 1", "Item 2", "Item 3", "Item 4" }));
        jccategorie.setToolTipText("Rechercher par nom ou cat√©gorie");

        jlprix.setText("<html>Prix: <font color='red'>*</font></html>");

        jlstock.setText("<html>Stock: <font color='red'>*</font></html>");

        jlFCFA.setText("FCFA");

        txtStock.setToolTipText("Quantit√© actuelle en stock");

        jlUnit√©s.setText("Unit√©s");

        jlSeuilalerte.setText("Seuil alerte:");

        txtSeuilAlerte.setToolTipText("Seuil minimum avant alerte de r√©approvisionnement");

        jLabel1.setText("(stock minimum)");

        jbenregistrer.setText("Enregistrer");
        jbenregistrer.setToolTipText("Enregistrer les modifications");
        jbenregistrer.addActionListener(this::jbenregistrerActionPerformed);

        jbannuler.setText("Annuler");
        jbannuler.setToolTipText("Annuler les modifications");
        jbannuler.addActionListener(this::jbannulerActionPerformed);

        jbreinitialiser.setText("R√©initialiser");
        jbreinitialiser.setToolTipText("R√©initialiser le formulaire");
        jbreinitialiser.addActionListener(this::jbreinitialiserActionPerformed);

        javax.swing.GroupLayout jPanel2Layout = new javax.swing.GroupLayout(jPanel2);
        jPanel2.setLayout(jPanel2Layout);
        jPanel2Layout.setHorizontalGroup(
            jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel2Layout.createSequentialGroup()
                .addContainerGap(51, Short.MAX_VALUE)
                .addComponent(jbenregistrer)
                .addGap(52, 52, 52)
                .addComponent(jbannuler)
                .addGap(40, 40, 40)
                .addComponent(jbreinitialiser)
                .addGap(70, 70, 70))
        );
        jPanel2Layout.setVerticalGroup(
            jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, jPanel2Layout.createSequentialGroup()
                .addContainerGap(9, Short.MAX_VALUE)
                .addGroup(jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(jbenregistrer)
                    .addComponent(jbannuler)
                    .addComponent(jbreinitialiser))
                .addContainerGap())
        );

        javax.swing.GroupLayout jpformulaireLayout = new javax.swing.GroupLayout(jpformulaire);
        jpformulaire.setLayout(jpformulaireLayout);
        jpformulaireLayout.setHorizontalGroup(
            jpformulaireLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jpformulaireLayout.createSequentialGroup()
                .addGap(50, 50, 50)
                .addGroup(jpformulaireLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(jlnom, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(jlcat√©gorie, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(jlstock, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(jlSeuilalerte)
                    .addComponent(jlprix, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addGap(61, 61, 61)
                .addGroup(jpformulaireLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(txtNom, javax.swing.GroupLayout.PREFERRED_SIZE, 352, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(jccategorie, javax.swing.GroupLayout.PREFERRED_SIZE, 199, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addGroup(jpformulaireLayout.createSequentialGroup()
                        .addGroup(jpformulaireLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING, false)
                            .addComponent(txtSeuilAlerte, javax.swing.GroupLayout.Alignment.LEADING, javax.swing.GroupLayout.DEFAULT_SIZE, 224, Short.MAX_VALUE)
                            .addComponent(txtStock, javax.swing.GroupLayout.Alignment.LEADING)
                            .addComponent(txtPrix, javax.swing.GroupLayout.Alignment.LEADING))
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addGroup(jpformulaireLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addComponent(jlFCFA)
                            .addComponent(jlUnit√©s)
                            .addComponent(jLabel1))))
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, jpformulaireLayout.createSequentialGroup()
                .addGap(0, 0, Short.MAX_VALUE)
                .addComponent(jPanel2, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
        );
        jpformulaireLayout.setVerticalGroup(
            jpformulaireLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jpformulaireLayout.createSequentialGroup()
                .addGap(37, 37, 37)
                .addGroup(jpformulaireLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(jlnom, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(txtNom, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addGap(39, 39, 39)
                .addGroup(jpformulaireLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(jlcat√©gorie, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(jccategorie, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addGap(43, 43, 43)
                .addGroup(jpformulaireLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(jlprix, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(txtPrix, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(jlFCFA))
                .addGap(39, 39, 39)
                .addGroup(jpformulaireLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(jlstock, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(txtStock, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(jlUnit√©s))
                .addGap(41, 41, 41)
                .addGroup(jpformulaireLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(jlSeuilalerte)
                    .addComponent(txtSeuilAlerte, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(jLabel1))
                .addGap(74, 74, 74)
                .addComponent(jPanel2, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(getContentPane());
        getContentPane().setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(layout.createSequentialGroup()
                        .addComponent(jPanel1, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                        .addContainerGap())
                    .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, layout.createSequentialGroup()
                        .addGap(0, 0, Short.MAX_VALUE)
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING, false)
                            .addComponent(jscrollPane, javax.swing.GroupLayout.DEFAULT_SIZE, 683, Short.MAX_VALUE)
                            .addComponent(jpformulaire, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
                        .addGap(69, 69, 69))))
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addContainerGap()
                .addComponent(jPanel1, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(28, 28, 28)
                .addComponent(jscrollPane, javax.swing.GroupLayout.PREFERRED_SIZE, 231, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, 45, Short.MAX_VALUE)
                .addComponent(jpformulaire, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(19, 19, 19))
        );

        pack();
    }// </editor-fold>//GEN-END:initComponents

    private void setupInterface() {
        // Centrer la fen√™tre
        setLocationRelativeTo(null);
        
        // Initialiser les DAOs
        produitDAO = new ProduitDAO();
        categorieDAO = new CategorieDAO();
        
        // Configurer le mod√®le de tableau
        configurerTableau();
        
        // Charger les donn√©es
        chargerCategories();
        chargerProduits();
        
        // Configurer les validations
        configurerValidations();
        
        // Ajouter les tooltips
        ajouterToolTips();
        
        // Configurer la recherche en temps r√©el
        configurerRecherche();
        
        // Initialiser en mode ajout
        activerModeAjout();
    }
    
    private void configurerTableau() {
        tableModel = (DefaultTableModel) jttableproduits.getModel();
        tableModel.setRowCount(0); // Vider le tableau
        
        // Cr√©er un RowSorter pour le tri et la recherche
        sorter = new TableRowSorter<>(tableModel);
        jttableproduits.setRowSorter(sorter);
        
        // Configurer les largeurs de colonnes
        jttableproduits.getColumnModel().getColumn(0).setPreferredWidth(50);  // ID
        jttableproduits.getColumnModel().getColumn(1).setPreferredWidth(200); // Nom
        jttableproduits.getColumnModel().getColumn(2).setPreferredWidth(120); // Cat√©gorie
        jttableproduits.getColumnModel().getColumn(3).setPreferredWidth(100); // Prix
        jttableproduits.getColumnModel().getColumn(4).setPreferredWidth(80);  // Stock
        jttableproduits.getColumnModel().getColumn(5).setPreferredWidth(100); // Seuil
        jttableproduits.getColumnModel().getColumn(6).setPreferredWidth(80);  // Statut
    }
    
    private void chargerCategories() {
        try {
            jccategorie.removeAllItems();
            jccategorie.addItem("-- S√©lectionnez une cat√©gorie --");
            
            List<Categorie> categories = categorieDAO.getAllCategories();
            for (Categorie categorie : categories) {
                jccategorie.addItem(categorie.getLibelle());
            }
            
            if (jccategorie.getItemCount() == 1) {
                logger.warning("Aucune cat√©gorie trouv√©e dans la base de donn√©es");
                JOptionPane.showMessageDialog(this, 
                    "Aucune cat√©gorie trouv√©e.\nVeuillez d'abord cr√©er des cat√©gories.",
                    "Information",
                    JOptionPane.INFORMATION_MESSAGE);
            }
        } catch (Exception e) {
            logger.severe("Erreur lors du chargement des cat√©gories: " + e.getMessage());
            JOptionPane.showMessageDialog(this,
                "Erreur lors du chargement des cat√©gories: " + e.getMessage(),
                "Erreur",
                JOptionPane.ERROR_MESSAGE);
        }
    }
    
    private void chargerProduits() {
        try {
            tableModel.setRowCount(0); // Vider le tableau
            
            List<Produit> produits = produitDAO.getAllProduits();
            for (Produit produit : produits) {
                String statut = "NORMAL";
                if (produit.getStockActuel() == 0) {
                    statut = "RUPTURE";
                } else if (produit.getStockActuel() <= produit.getSeuilAlerte()) {
                    statut = "ALERTE";
                }
                
                tableModel.addRow(new Object[]{
                    produit.getId(),
                    produit.getNom(),
                    produit.getCategorie().getLibelle(),
                    produit.getPrixVente(),
                    produit.getStockActuel(),
                    produit.getSeuilAlerte(),
                    statut
                });
            }
            
            if (tableModel.getRowCount() == 0) {
                logger.info("Aucun produit trouv√© dans la base de donn√©es");
            } else {
                logger.info(tableModel.getRowCount() + " produits charg√©s");
            }
        } catch (Exception e) {
            logger.severe("Erreur lors du chargement des produits: " + e.getMessage());
            JOptionPane.showMessageDialog(this,
                "Erreur lors du chargement des produits: " + e.getMessage(),
                "Erreur",
                JOptionPane.ERROR_MESSAGE);
        }
    }
    
    private void configurerValidations() {
        // Emp√™cher les lettres dans les champs num√©riques
        txtPrix.addKeyListener(new KeyAdapter() {
            @Override
            public void keyTyped(KeyEvent e) {
                char c = e.getKeyChar();
                if (!Character.isDigit(c) && c != '.' && c != KeyEvent.VK_BACK_SPACE && c != KeyEvent.VK_DELETE) {
                    e.consume();
                }
            }
        });
        
        txtStock.addKeyListener(new KeyAdapter() {
            @Override
            public void keyTyped(KeyEvent e) {
                char c = e.getKeyChar();
                if (!Character.isDigit(c) && c != KeyEvent.VK_BACK_SPACE && c != KeyEvent.VK_DELETE) {
                    e.consume();
                }
            }
        });
        
        txtSeuilAlerte.addKeyListener(new KeyAdapter() {
            @Override
            public void keyTyped(KeyEvent e) {
                char c = e.getKeyChar();
                if (!Character.isDigit(c) && c != KeyEvent.VK_BACK_SPACE && c != KeyEvent.VK_DELETE) {
                    e.consume();
                }
            }
        });
    }
    
    private void ajouterToolTips() {
        // Boutons de la barre d'outils
        jbajouter.setToolTipText("<html><b>Ajouter un nouveau produit</b><br>Remplissez le formulaire ci-dessous</html>");
        jbmodifier.setToolTipText("<html><b>Modifier le produit s√©lectionn√©</b><br>S√©lectionnez d'abord un produit dans le tableau</html>");
        jbsupprimer.setToolTipText("<html><b>Supprimer le produit s√©lectionn√©</b><br>S√©lectionnez d'abord un produit dans le tableau</html>");
        jbactualiser.setToolTipText("<html><b>Actualiser la liste des produits</b><br>Recharger les donn√©es depuis la base</html>");
        jbrechercher.setToolTipText("<html><b>Rechercher un produit</b><br>Cliquez pour lancer la recherche</html>");
        
        // Champs du formulaire
        txtNom.setToolTipText("<html><b>Nom du produit</b><br>Champ obligatoire</html>");
        jccategorie.setToolTipText("<html><b>Cat√©gorie du produit</b><br>S√©lectionnez une cat√©gorie existante</html>");
        txtPrix.setToolTipText("<html><b>Prix de vente</b><br>‚Ä¢ Doit √™tre sup√©rieur √† 0<br>‚Ä¢ Format: nombre d√©cimal<br>‚Ä¢ Exemple: 1500.50</html>");
        txtStock.setToolTipText("<html><b>Quantit√© en stock</b><br>‚Ä¢ Doit √™tre positive<br>‚Ä¢ Exemple: 50</html>");
        txtSeuilAlerte.setToolTipText("<html><b>Seuil d'alerte</b><br>‚Ä¢ Stock minimum avant alerte<br>‚Ä¢ Exemple: 10</html>");
        jtrechercher.setToolTipText("<html><b>Recherche rapide</b><br>‚Ä¢ Tapez pour rechercher par nom ou cat√©gorie<br>‚Ä¢ La recherche est instantan√©e</html>");
        
        // Boutons du formulaire
        jbenregistrer.setToolTipText("<html><b>Enregistrer les modifications</b><br>Valider le formulaire</html>");
        jbannuler.setToolTipText("<html><b>Annuler les modifications</b><br>Vider le formulaire</html>");
        jbreinitialiser.setToolTipText("<html><b>R√©initialiser le formulaire</b><br>Remettre √† z√©ro tous les champs</html>");
        
        // Tableau
        jttableproduits.setToolTipText("<html><b>Liste des produits</b><br>‚Ä¢ Double-cliquez sur une ligne pour la modifier<br>‚Ä¢ Cliquez une fois pour la s√©lectionner</html>");
    }
    
    private void configurerRecherche() {
        // Recherche en temps r√©el
        jtrechercher.getDocument().addDocumentListener(new DocumentListener() {
            @Override
            public void insertUpdate(DocumentEvent e) {
                filtrerTableau();
            }
            @Override
            public void removeUpdate(DocumentEvent e) {
                filtrerTableau();
            }
            @Override
            public void changedUpdate(DocumentEvent e) {
                filtrerTableau();
            }
        });
    }
    
    private void filtrerTableau() {
        String texte = jtrechercher.getText().toLowerCase();
        if (texte.trim().isEmpty()) {
            sorter.setRowFilter(null);
        } else {
            sorter.setRowFilter(RowFilter.regexFilter("(?i)" + texte, 1, 2)); // Colonnes Nom et Cat√©gorie
        }
    }
    
    private void activerModeAjout() {
        modeAjout = true;
        produitSelectionneId = -1;
        jbenregistrer.setText("Ajouter");
        reinitialiserFormulaire();
        jttableproduits.clearSelection();
    }
    
    private void activerModeModification(int id) {
        modeAjout = false;
        produitSelectionneId = id;
        jbenregistrer.setText("Modifier");
    }
    
    private void reinitialiserFormulaire() {
        txtNom.setText("");
        txtPrix.setText("");
        txtStock.setText("");
        txtSeuilAlerte.setText("5"); // Valeur par d√©faut
        if (jccategorie.getItemCount() > 0) {
            jccategorie.setSelectedIndex(0);
        }
    }
    
    private boolean validerFormulaire() {
        // Validation du nom
        if (txtNom.getText().trim().isEmpty()) {
            JOptionPane.showMessageDialog(this, 
                "Veuillez saisir un nom pour le produit.",
                "Erreur de validation",
                JOptionPane.ERROR_MESSAGE);
            txtNom.requestFocus();
            return false;
        }
        
        // Validation de la cat√©gorie
        if (jccategorie.getSelectedIndex() <= 0) {
            JOptionPane.showMessageDialog(this, 
                "Veuillez s√©lectionner une cat√©gorie.",
                "Erreur de validation",
                JOptionPane.ERROR_MESSAGE);
            jccategorie.requestFocus();
            return false;
        }
        
        // Validation du prix
        try {
            double prix = Double.parseDouble(txtPrix.getText().trim());
            if (prix <= 0) {
                JOptionPane.showMessageDialog(this, 
                    "Le prix doit √™tre sup√©rieur √† 0.",
                    "Erreur de validation",
                    JOptionPane.ERROR_MESSAGE);
                txtPrix.requestFocus();
                return false;
            }
        } catch (NumberFormatException e) {
            JOptionPane.showMessageDialog(this, 
                "Veuillez saisir un prix valide.",
                "Erreur de validation",
                JOptionPane.ERROR_MESSAGE);
            txtPrix.requestFocus();
            return false;
        }
        
        // Validation du stock
        try {
            int stock = Integer.parseInt(txtStock.getText().trim());
            if (stock < 0) {
                JOptionPane.showMessageDialog(this, 
                    "Le stock ne peut pas √™tre n√©gatif.",
                    "Erreur de validation",
                    JOptionPane.ERROR_MESSAGE);
                txtStock.requestFocus();
                return false;
            }
        } catch (NumberFormatException e) {
            JOptionPane.showMessageDialog(this, 
                "Veuillez saisir une quantit√© de stock valide.",
                "Erreur de validation",
                JOptionPane.ERROR_MESSAGE);
            txtStock.requestFocus();
            return false;
        }
        
        // Validation du seuil d'alerte
        try {
            int seuil = Integer.parseInt(txtSeuilAlerte.getText().trim());
            if (seuil < 0) {
                JOptionPane.showMessageDialog(this, 
                    "Le seuil d'alerte ne peut pas √™tre n√©gatif.",
                    "Erreur de validation",
                    JOptionPane.ERROR_MESSAGE);
                txtSeuilAlerte.requestFocus();
                return false;
            }
        } catch (NumberFormatException e) {
            JOptionPane.showMessageDialog(this, 
                "Veuillez saisir un seuil d'alerte valide.",
                "Erreur de validation",
                JOptionPane.ERROR_MESSAGE);
            txtSeuilAlerte.requestFocus();
            return false;
        }
        
        return true;
    }
    
    private void enregistrerProduit() {
        if (!validerFormulaire()) {
            return;
        }
        
        try {
            // R√©cup√©rer la cat√©gorie s√©lectionn√©e
            String categorieLibelle = (String) jccategorie.getSelectedItem();
            List<Categorie> categories = categorieDAO.getAllCategories();
            Categorie categorieSelectionnee = null;
            
            for (Categorie categorie : categories) {
                if (categorie.getLibelle().equals(categorieLibelle)) {
                    categorieSelectionnee = categorie;
                    break;
                }
            }
            
            if (categorieSelectionnee == null) {
                JOptionPane.showMessageDialog(this,
                    "Cat√©gorie non trouv√©e.",
                    "Erreur",
                    JOptionPane.ERROR_MESSAGE);
                return;
            }
            
            // Cr√©er l'objet Produit
            Produit produit = new Produit();
            produit.setNom(txtNom.getText().trim());
            produit.setCategorie(categorieSelectionnee);
            produit.setPrixVente(Double.parseDouble(txtPrix.getText().trim()));
            produit.setStockActuel(Integer.parseInt(txtStock.getText().trim()));
            produit.setSeuilAlerte(Integer.parseInt(txtSeuilAlerte.getText().trim()));
            
            boolean success;
            String message;
            
            if (modeAjout) {
                // Mode ajout
                success = produitDAO.addProduit(produit);
                message = success ? "Produit ajout√© avec succ√®s!" : "Erreur lors de l'ajout du produit.";
            } else {
                // Mode modification
                produit.setId(produitSelectionneId);
                success = produitDAO.updateProduit(produit);
                message = success ? "Produit modifi√© avec succ√®s!" : "Erreur lors de la modification du produit.";
            }
            
            if (success) {
                JOptionPane.showMessageDialog(this, message, "Succ√®s", JOptionPane.INFORMATION_MESSAGE);
                chargerProduits();
                activerModeAjout();
            } else {
                JOptionPane.showMessageDialog(this, message, "Erreur", JOptionPane.ERROR_MESSAGE);
            }
            
        } catch (Exception e) {
            logger.severe("Erreur lors de l'enregistrement du produit: " + e.getMessage());
            JOptionPane.showMessageDialog(this,
                "Erreur lors de l'enregistrement: " + e.getMessage(),
                "Erreur",
                JOptionPane.ERROR_MESSAGE);
        }
    }
    
    private void supprimerProduit() {
        int selectedRow = jttableproduits.getSelectedRow();
        if (selectedRow == -1) {
            JOptionPane.showMessageDialog(this,
                "Veuillez s√©lectionner un produit √† supprimer.",
                "Aucune s√©lection",
                JOptionPane.WARNING_MESSAGE);
            return;
        }
        
        // Convertir l'index de la vue √† l'index du mod√®le
        int modelRow = jttableproduits.convertRowIndexToModel(selectedRow);
        int id = (int) tableModel.getValueAt(modelRow, 0);
        String nom = (String) tableModel.getValueAt(modelRow, 1);
        
        int confirmation = JOptionPane.showConfirmDialog(this,
            "√ätes-vous s√ªr de vouloir supprimer le produit :\n\"" + nom + "\"?",
            "Confirmation de suppression",
            JOptionPane.YES_NO_OPTION,
            JOptionPane.WARNING_MESSAGE);
        
        if (confirmation == JOptionPane.YES_OPTION) {
            try {
                boolean success = produitDAO.deleteProduit(id);
                if (success) {
                    JOptionPane.showMessageDialog(this,
                        "Produit supprim√© avec succ√®s!",
                        "Succ√®s",
                        JOptionPane.INFORMATION_MESSAGE);
                    chargerProduits();
                    activerModeAjout();
                } else {
                    JOptionPane.showMessageDialog(this,
                        "Erreur lors de la suppression du produit.\nLe produit est peut-√™tre utilis√© dans des commandes.",
                        "Erreur",
                        JOptionPane.ERROR_MESSAGE);
                }
            } catch (Exception e) {
                logger.severe("Erreur lors de la suppression du produit: " + e.getMessage());
                JOptionPane.showMessageDialog(this,
                    "Erreur lors de la suppression: " + e.getMessage(),
                    "Erreur",
                    JOptionPane.ERROR_MESSAGE);
            }
        }
    }
    
    
    
    private void txtNomActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_txtNomActionPerformed
        // TODO add your handling code here:
    }//GEN-LAST:event_txtNomActionPerformed

    private void jbajouterActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jbajouterActionPerformed
        activerModeAjout();
    }//GEN-LAST:event_jbajouterActionPerformed

    private void jbmodifierActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jbmodifierActionPerformed
        int selectedRow = jttableproduits.getSelectedRow();
        if (selectedRow == -1) {
            JOptionPane.showMessageDialog(this,
                "Veuillez s√©lectionner un produit √† modifier.",
                "Aucune s√©lection",
                JOptionPane.WARNING_MESSAGE);
            return;
        }
        
        // R√©cup√©rer les donn√©es de la ligne s√©lectionn√©e
        int modelRow = jttableproduits.convertRowIndexToModel(selectedRow);
        int id = (int) tableModel.getValueAt(modelRow, 0);
        String nom = (String) tableModel.getValueAt(modelRow, 1);
        String categorie = (String) tableModel.getValueAt(modelRow, 2);
        double prix = (double) tableModel.getValueAt(modelRow, 3);
        int stock = (int) tableModel.getValueAt(modelRow, 4);
        int seuil = (int) tableModel.getValueAt(modelRow, 5);
        
        // Remplir le formulaire
        txtNom.setText(nom);
        
        // S√©lectionner la cat√©gorie dans la combo
        for (int i = 0; i < jccategorie.getItemCount(); i++) {
            if (jccategorie.getItemAt(i).equals(categorie)) {
                jccategorie.setSelectedIndex(i);
                break;
            }
        }
        
        txtPrix.setText(String.valueOf(prix));
        txtStock.setText(String.valueOf(stock));
        txtSeuilAlerte.setText(String.valueOf(seuil));
        
        // Activer le mode modification
        activerModeModification(id);
    }//GEN-LAST:event_jbmodifierActionPerformed

    private void jbsupprimerActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jbsupprimerActionPerformed
        supprimerProduit();
    }//GEN-LAST:event_jbsupprimerActionPerformed

    private void jbactualiserActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jbactualiserActionPerformed
        chargerProduits();
        chargerCategories();
        JOptionPane.showMessageDialog(this,
            "Liste des produits actualis√©e.",
            "Actualisation",
            JOptionPane.INFORMATION_MESSAGE);
    }//GEN-LAST:event_jbactualiserActionPerformed

    private void jbrechercherActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jbrechercherActionPerformed
        filtrerTableau();
        if (jtrechercher.getText().trim().isEmpty()) {
            JOptionPane.showMessageDialog(this,
                "Veuillez saisir un terme de recherche.",
                "Recherche",
                JOptionPane.INFORMATION_MESSAGE);
        }
    }//GEN-LAST:event_jbrechercherActionPerformed

    private void jbenregistrerActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jbenregistrerActionPerformed
        enregistrerProduit();
    }//GEN-LAST:event_jbenregistrerActionPerformed

    private void jbannulerActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jbannulerActionPerformed
        activerModeAjout();
        JOptionPane.showMessageDialog(this,
            "Op√©ration annul√©e. Formulaire r√©initialis√©.",
            "Annulation",
            JOptionPane.INFORMATION_MESSAGE);
    }//GEN-LAST:event_jbannulerActionPerformed

    private void jbreinitialiserActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jbreinitialiserActionPerformed
        reinitialiserFormulaire();
    }//GEN-LAST:event_jbreinitialiserActionPerformed

    private void jttableproduitsMouseClicked(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_jttableproduitsMouseClicked
        if (evt.getClickCount() == 2) { // Double-clic
            jbmodifierActionPerformed(null);
        }
    }//GEN-LAST:event_jttableproduitsMouseClicked

    private void initialiserDonnees() {
        // V√©rifier la connexion √† la base
        try {
            // Tenter de charger les cat√©gories pour v√©rifier la connexion
            chargerCategories();
            logger.info("GestionProduitsForm initialis√© avec succ√®s");
        } catch (Exception e) {
            logger.severe("Erreur d'initialisation: " + e.getMessage());
            JOptionPane.showMessageDialog(this,
                "Impossible de se connecter √† la base de donn√©es.\n" +
                "Veuillez v√©rifier que MySQL est d√©marr√©.\n\n" +
                "Erreur: " + e.getMessage(),
                "Erreur de connexion",
                JOptionPane.ERROR_MESSAGE);
        }
    }
    
    
    /**
     * @param args the command line arguments
     */
    public static void main(String args[]) {
        /* Set the Nimbus look and feel */
        //<editor-fold defaultstate="collapsed" desc=" Look and feel setting code (optional) ">
        try {
            for (javax.swing.UIManager.LookAndFeelInfo info : javax.swing.UIManager.getInstalledLookAndFeels()) {
                if ("Nimbus".equals(info.getName())) {
                    javax.swing.UIManager.setLookAndFeel(info.getClassName());
                    break;
                }
            }
        } catch (ReflectiveOperationException | javax.swing.UnsupportedLookAndFeelException ex) {
            logger.log(java.util.logging.Level.SEVERE, null, ex);
        }
        
        // Utiliser le look and feel syst√®me
        try {
            UIManager.setLookAndFeel(UIManager.getSystemLookAndFeelClassName());
        } catch (Exception e) {
            logger.log(java.util.logging.Level.WARNING, null, e);
        }
        //</editor-fold>

        /* Create and display the form */
        java.awt.EventQueue.invokeLater(() -> {
            GestionProduitsForm form = new GestionProduitsForm();
            form.setLocationRelativeTo(null); // Centrer la fen√™tre
            form.setVisible(true);
        });
    }


    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JLabel jLabel1;
    private javax.swing.JPanel jPanel1;
    private javax.swing.JPanel jPanel2;
    private javax.swing.JButton jbactualiser;
    private javax.swing.JButton jbajouter;
    private javax.swing.JButton jbannuler;
    private javax.swing.JButton jbenregistrer;
    private javax.swing.JButton jbmodifier;
    private javax.swing.JButton jbrechercher;
    private javax.swing.JButton jbreinitialiser;
    private javax.swing.JButton jbsupprimer;
    private javax.swing.JComboBox<String> jccategorie;
    private javax.swing.JLabel jlFCFA;
    private javax.swing.JLabel jlSeuilalerte;
    private javax.swing.JLabel jlUnit√©s;
    private javax.swing.JLabel jlcat√©gorie;
    private javax.swing.JLabel jlnom;
    private javax.swing.JLabel jlprix;
    private javax.swing.JLabel jlrechercher;
    private javax.swing.JLabel jlstock;
    private javax.swing.JPanel jpformulaire;
    private javax.swing.JScrollPane jscrollPane;
    private javax.swing.JTextField jtrechercher;
    private javax.swing.JTable jttableproduits;
    private javax.swing.JTextField txtNom;
    private javax.swing.JTextField txtPrix;
    private javax.swing.JTextField txtSeuilAlerte;
    private javax.swing.JTextField txtStock;
    // End of variables declaration//GEN-END:variables
}
